import { compareTwoSnapshots } from "./compareTwoSnapshots.js"
import { renderDirectoryImpact } from "./renderDirectoryImpact.js"
import { renderFilesImpact } from "./renderFilesImpact.js"
import { renderCacheImpact } from "./renderCacheImpact.js"

export const generatePullRequestCommentString = ({
  pullRequestBase,
  pullRequestHead,
  baseVersionnedSnapshot,
  headVersionnedSnapshot,
  formatSize,
  commentSections,
  generatedByLink,
}) => {
  const warnings = []

  let baseSnapshot
  const headSnapshot = headVersionnedSnapshot.snapshot

  // this is an indirect way of detecting that there is an error while generating snapshot
  // There is || echo "{}" > ../snapshot.base.json in size-impact.yml
  if (Object.keys(baseVersionnedSnapshot).length === 0) {
    baseSnapshot = {}
    warnings.push(
      `**Warning:** Only \`${pullRequestHead}\` files are taken into account below.
It happens because \`${pullRequestBase}\` files are missing.
This occurs when there is an error executing \`@jsenv/github-pull-request-filesize-impact\` scripts.
It's likely because scripts are not in \`${pullRequestBase}\` branch.
This is normal when adding \`@jsenv/github-pull-request-filesize-impact\` for the first time.`,
    )
  } else {
    const baseVersion = baseVersionnedSnapshot.version
    const headVersion = headVersionnedSnapshot.version

    if (baseVersion === headVersion) {
      baseSnapshot = baseVersionnedSnapshot.snapshot
    } else {
      baseSnapshot = {}
      warnings.push(
        `**Warning:** Only \`${pullRequestHead}\` files are taken into account below.
It happens because versions of \`@jsenv/github-pull-request-filesize-impact\` are too different on \`${pullRequestBase}\` and \`${pullRequestHead}\`.`,
      )
    }
  }

  const snapshotComparison = compareTwoSnapshots(baseSnapshot, headSnapshot)
  const groups = Object.keys(snapshotComparison)

  if (groups.length === 0) {
    warnings.push(`**Warning:**: The comparison is empty, check your tracking config.`)
  }

  return `<!-- Generated by @jsenv/github-pull-request-filesize-impact -->
${renderWarnings(warnings)}
${renderBody({
  snapshotComparison,
  pullRequestBase,
  pullRequestHead,
  commentSections,
  formatSize,
})}${generatedByLink ? renderGeneratedByLink() : ""}`
}

const renderWarnings = (warnings) => {
  if (warnings.length === 0) {
    return ""
  }

  return `
---

${warnings.join(`

`)}

---
`
}

const renderBody = ({
  snapshotComparison,
  pullRequestBase,
  pullRequestHead,
  commentSections,
  formatSize,
}) => {
  const directoryMessages = Object.keys(snapshotComparison).map((directoryRelativeUrl) => {
    const directoryComparison = snapshotComparison[directoryRelativeUrl]

    return `<details>
  <summary>${generateSummary(directoryRelativeUrl)}</summary>
${generateDetails(directoryComparison, {
  directoryRelativeUrl,
  pullRequestBase,
  pullRequestHead,
  commentSections,
  formatSize: (value, ...rest) => {
    // call formatSize only on numbers 'error' must be returned untouched
    if (typeof value === "number") return formatSize(value, ...rest)
    return value
  },
})}
</details>`
  })

  return directoryMessages.join(`

`)
}

const generateSummary = (directoryRelativeUrl) => directoryRelativeUrl

const COMMENT_NAME_TO_RENDER = {
  directoryImpact: renderDirectoryImpact,
  filesImpact: renderFilesImpact,
  cacheImpact: renderCacheImpact,
}

const generateDetails = (
  directoryComparison,
  { directoryRelativeUrl, pullRequestBase, pullRequestHead, commentSections, formatSize },
) => {
  return Object.keys(commentSections)
    .filter((commentSectionName) => commentSections[commentSectionName])
    .map((commentSectionName) => {
      const renderCommentSection = COMMENT_NAME_TO_RENDER[commentSectionName]
      if (!renderCommentSection) {
        console.warn(
          `unknown comment section ${commentSectionName}. Available comment section are ${Object.keys(
            COMMENT_NAME_TO_RENDER,
          )} `,
        )
        return ""
      }
      return renderCommentSection(directoryComparison, {
        directoryRelativeUrl,
        pullRequestBase,
        pullRequestHead,
        formatSize,
      })
    }).join(`
`)
}

const renderGeneratedByLink = () => {
  return `

<sub>
  Generated by <a href="https://github.com/jsenv/jsenv-github-pull-request-filesize-impact">github pull request filesize impact</a>
</sub>`
}
